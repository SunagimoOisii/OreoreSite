# 改善タスク（重複・拡張性・保守性・可読性）

目的別に改善タスクを整理しています。優先度が高い順に上から配置しています。実装前に粒度や依存を見直してください。

## 重複の削減

- [finished]`src/entry/title-tricks.entry.js` の UFO や house の生成処理をユーティリティ化し、繰り返している DOM 生成とタイマー解放の手順を 1 箇所にまとめる。
- [finished]`src/features/avatar/mesh.js` での Box/Tetra/Sphere/Torus の作成ロジックを形状ごとのテーブルに整理し、`createAvatarMesh` と `changeAvatarShape` から共有してジオメトリ生成を単一実装へ寄せる。

## 拡張性の向上

- [finished]`src/entry/title-tricks.entry.js` の `registerTrick` 群をキャラクター定義配列＋初期化ルーチンに再構成し、新しいトリック追加時も 1 箇所の追記で完結するようにする。
- []`src/features/background/controller.js` のワイヤーフレーム形状分岐を設定テーブル＋ビルダー関数に置き換え、追加形状を設定ファイルから注入できるようにする。

## 保守性の改善

- [finished]`src/entry/title-tricks.entry.js` に破棄 API を用意し、クリックリスナーとトリック登録を明示的に解除できるようにして再初期化時のリークを防ぐ。

## 可読性の向上

- [finished]`src/features/background/controller.js` の `updateInner` から座標計算を純粋関数へ切り出し、変数名とコメントで役割を明示して読み解きコストを下げる。

---

実装メモ:
- 既存の振る舞いを保持するため、デフォルト設定は現行値に合わせる。

## 設計ガイド

- 後方互換性は、最終的に気にしなくていい
- 機能ローカル化: 設定やユーティリティは可能な限り該当機能配下に置く。横断 `utils` は最小限・小粒度に留める。
- 純粋関数優先: three/DOM 副作用とロジックを分離。ロジックは純粋（引数→戻り値）に寄せ、UI刷新やレンダラ差し替えに耐える。
- オプトイン設計: 新モード/新ルールは既定で無効。既存挙動は保持する。
- 設定の境界: 描画系（エフェクト/レンダラ）と機能系（背景/Works）の設定を分離し、依存方向を一方向に保つ。
- ライフサイクル管理: リスナーやリソース（RT/Geo/Mat）は生成と廃棄の責務を分け、`dispose()` で確実に解放する。
- 名前付けと定数化: マジックナンバー（時間・半径・回転速度等）は意味のある定数名で一箇所に集約。
- エラーとフォールバック: ネットワーク/JSON 失敗時のフォールバックデータは定数で一元管理し、UI側も空ケースを考慮。
- 型とJSDoc: エントリポイント/主要APIには最小限のJSDocで契約（引数・戻り値・例外）を明示する。
- 過剰抽象化の回避: 抽象は「2つ以上の実利用」が揃ってから。第1ステップでは機能ローカルで小さく切り出す。
- 計測と実験フラグ: パフォーマンスや実験的機能は計測フック/フラグで独立させ、本流ロジックを汚さない。

